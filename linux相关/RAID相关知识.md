# RAID相关知识

- RAID的常见级别及含义
  - RAID 0 striping条带方式，提高单盘吞吐率
  - RAID 1 mirroring镜像方式，提高可靠性
  - RAID 5 有奇偶校验
  - RAID 10是RAID 1与RAID 0的结合

## 01 RAID基础

RAID基础之作用（Redundant Arrays of Independent Drives，独立冗余磁盘阵列）。

RAID的功能：

一、比如你的D盘数据越来越多，并超过了市面上能买到的单个硬盘最大容量时，你就需要RAID。多个硬盘组成RAID之后能给你一个逻辑上的超大D盘。很多人说，大不了分开放，但移动几个T的数据并不轻松，在企业级中也不会允许随便迁移数据，更别提现在的文件个体也是越来越大。

二、更好的读写性能

在组成RAID后，每一次读写都会有多个硬盘来进行分流，单位时间的处理能力就会得到提升。

三、配合RAID的容错机制实现了损坏一块或者两块硬盘，并不会导致数据丢失。同时RAID控制器会把故障的硬盘做隔离。只要你更换及时，维护起来也相当地简单。

至于很多人说，搭建RAID并不划算，其实这种说法比较片面。举一个例子，两个4T的硬盘搭建RAID 0后，性能也比单个8T要强不少。也比单个8T便宜，对企业级来说更是这样，很多时候我们需要满足多少多少的IOPS和多大的一个吞吐量，用普通硬盘组建成RAID才是性价比最高的。

**RAID的种类：**

- RAID 0 (stripe，条带)
- RAID 1 (mirror，镜像)
- RAID 5 (单校验XOR）
- RAID 6 (XOR+Galois Field)
- RAID 01 (底层RAID 0，顶层RAID 1)
- RAID 10 (底层RAID 1，顶层RAID 0)

**RAID基础之RAID 0**

**工作机制**

​	磁盘均响应IO请求并互相等待数据块拆分至所有磁盘成员A = A1+A2+A3+A4

**性能及容量**

​	读=最低Disk性能*N

​	写=最低Disk性能*N

​	Capacity=最小Disk容量*N

​	额外CPU Cost： 几乎为0

**容错及恢复难度**

​	不可容忍任意成员offline

​	是否需要专用热备：不适用

【详解】：相信大部分人对RAID 0都非常熟悉，数据块会均分到所有硬盘上，大家可以参考一下以下的公式A，很多人都以为搭建RAID跟CPU没什么关系，其实是有的，不同RAID对CPU造成的额外消耗也是不一致，RAID 0由于不涉及到校验算法，所以对CPU的消耗会很低。等一下，这里说的CPU消耗是指除了包括主板上的那个以外，还包括RAID控制器里面的CPU。唯一想跟大家强调的是，无论是读性能还是写性能，都会受限于某个最慢的硬盘，容量也是一样的道理，如果你拿1T和2T组成RAID 0，一共也只会有2T可以用，如果你突然发现RAID 0读写很慢，有可能就是某个硬盘有隐患，导致其他硬盘一直在等待，所以你要做的就是赶紧备份你的数据，当然啦，如果是突发性的物理故障，也是没有什么征兆的。

**RAID基础之RAID 1**

工作机制

​	磁盘写入动作互相等待，磁盘读取动作"先到先返回"

​	数据块克隆至所有磁盘成员A=A1（Disk1、Disk2）

​	A=A1（Disk1、Disk2）

性能及容量

​	读=最快Disk性能-存疑？

​	写=最慢Disk性能

​	Capacity=最小Disk容量

​	额外CPU Cost：几乎为0

容错及恢复难度

​	可容忍任意1个成员offline

​	重构速度（风险）：快

​	是否需要专用热备：不需要

【详解】：RAID 1比RAID 0更简单，就是四个字，实时镜像。RAID 1可以坏任意一块硬盘，他对CPU的消耗也很低，这里可能很多人会问，为什么明明有两份数据，RAID 1的读取性能却不能翻倍呢？道理其实很简单，就是因为同一时间永远只有一份完整的数据从1个硬盘上返回。那RAID 1究竟对读取有没有帮助呢？其实也是有的，RAID1在接收读取信号的时候，两个硬盘会同时响应，并且取出相应的文件返回给RAID控制器。控制器这时候只会选择最快的那一份返回给操作系统，理论上来说，如果是固态硬盘和机械硬盘组成的RAID1，那么这时候读取的性能应该是能达到固态硬盘的，关于这一点，我自己也在想能不能再直播中做一下实验，因为从来没有人拿过固态硬盘和机械硬盘去做RAID 1。

**RAID基础之RAID 5**

工作机制

​	数据块拆分至所有磁盘成员

​	校验块对应且不在同一磁盘

​	A = A1+A2+A3

​	Ap = A1 xor A2 xor A3

性能及容量

​	读<=最低Disk性能*（N-1）

​	写<=最低Disk性能*（N-1）

​	Capacity=最小Disk容量*（N-1）

​	额外CPU Cost： 5%~10%

容错及恢复难度

​	可容忍任意1个成员offline

​	是否需要专用热备：必备

【详解】当你手上硬盘超过四块的时候，很多人就会选择RAID 5，事实上，RAID 5 一直是一个性价比超高的模式，但也不是完全没有缺陷，以一个四盘位的RAID 5为例。我们先看一下公式，数据块A依然拆分为三份存在不同的硬盘，通过三份数据的异或运算会再得出一个校验数据Ap，只要A1，A2，A3和Ap不要同时丢失两个，其他都可以用公式算出来。需要强调的是，Ap一定会存放在跟A1、A2、A3不同的硬盘中，这里注意是一定会，所以很多人说”RAID 5里面有一个硬盘用来存放校验数据“，这种说法是完全错误的，校验数据不会固定在一个硬盘中，它是在每个硬盘中都占了一部分，只不过总占用的容量相当于一个成员硬盘的容量而已，这个也是我们经常问的面试题。RAID 5需要进行一次异或运算，就会有消耗一定的CPU，但换来的性能几乎接近理想状态，也就是N-1个硬盘的性能倍数，可用空间也是N-1个最小容量硬盘的倍数，虽说RAID 5可以容忍一个硬盘故障，但在使用过程中还是得老老实实多买一个硬盘做热备盘，因为如果发生一个硬盘离线的时候，为了保证数据正常读取，校验运算会一直进行，其他所有硬盘都会处于很忙的状态，如此一来就更容易发生故障，如果再出现第二个硬盘损坏，那只能听天由命了。为什么我会说是听天由命呢？因为有一个种情况，哪怕坏4个硬盘，一样能恢复，比如这样，如果你的运气足够好，当故障硬盘两个以上或者是全部都故障时，只要他的坏道部分不重叠，那依然可以进行手工恢复。

**RAID基础之RAID 6**

【详解】RAID 6在RAID 5的基础上又多了一份Q校验，Q校验的算法和XOR校验不一样，它是采用一种叫做伽罗华域的四则运算，并且搭配了XOR，由于是双重校验，他对CPU的开销特别大，读写性能也达不到有效磁盘倍数的理想状态，但是为什么越来越流行呢？因为它能降低大容量硬盘在RAID 5后期的使用风险，随着硬盘容量越来越大，大家会发现用来组建RAID 5很不合适，当RAID 5损坏一个硬盘后，他的重构时间会随着硬盘容量越大而越久，这就意味着其他盘再发生损坏的时间窗口也会越来越大。但RAID 6在只损坏1个硬盘的情况下，如果再发生故障一样可以重构回来，这里可能会有人说不就多了一块嘛，也有可能再坏呀，但实际上就是因为多了这么一个硬盘，它的安全性超越了RAID 5 1000倍，这个数字也是毫不夸张。

**RAID基础之RAID 01**

- 工作机制

  磁盘写入动作互相等待

  磁盘读取动作 ”先到先返回“

  数据块拆分至RAID 0组A

  RAID 0组A与RAID 0组B互为Mirror

- 性能及容量

  读写 = （Disk1+Disk2）/（Disk3+Disk4）

  Capacity = 最小Disk容量*（N/2）

  额外CPU Cost： < 5%

- 容错及恢复难度

  可容忍任意1个成员offline

  可容忍特定情况半数成员offline

  是否需要专用热备：必备

【详解】RAID 01其实就是底层RAID 0，顶层RAID 1，底层两个RAID 0相互镜像，容量和性能都只有50%的磁盘成员来提供，CPU消耗也比较小，值得一说的是，RAID 01的极限状态是可以容忍一半磁盘故障的，不过很多RAID的控制器都会有保护措施，不会让你遇到这种情况。

**RAID基础之RAID 10**

- 工作机制

  磁盘均响应IO请求并互相等待

  数据块拆分至2个RAID 1组

  RAID 1组A与RAID 1组B并发为RAID 0

- 性能及容量

  读写 = （Disk1 + Disk3）/ （Disk2+Disk4）

  Capacity = 最小Disk容量*（N/2）

  额外CPU  Cost： < 5%

- 容错及恢复难度

  可容忍任意1个成员offline

  可容忍特定情况半数成员offline

  是否需要专用热备：建议

【详解】RAID 10底层RAID 1，顶层RAID 0，底层可以是很多个独立的RAID 1，由于容量、性能、CPU占用都跟RAID 01相差不大，这里就不再赘述。重点讲一下故障情景，RAID 01的风险是特别高的，也就是安全性相较于RAID 10特别差，所以在企业级的应用中，几乎没有人会使用RAID 01。

![1571062890076](https://raw.githubusercontent.com/lzgkj1992/markdown_images/master/1571062890076.png)



